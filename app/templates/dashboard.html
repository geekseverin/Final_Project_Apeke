<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Big Data Dashboard - Traitement Distribu√©</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöÄ Big Data Dashboard</h1>
            <p>Projet Traitement Distribu√© 2024-2025</p>
        </header>

        <div class="status-bar">
            <div class="status-item">
                <span class="status-label">Cluster Status:</span>
                <span id="cluster-status" class="status-value">Checking...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Last Update:</span>
                <span id="last-update" class="status-value">-</span>
            </div>
        </div>

        <div class="grid">
            <!-- M√©triques g√©n√©rales -->
            <div class="card">
                <h3>üìä M√©triques G√©n√©rales</h3>
                <div class="metrics">
                    <div class="metric">
                        <span class="metric-value" id="total-sales">-</span>
                        <span class="metric-label">Total Ventes</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="total-customers">-</span>
                        <span class="metric-label">Clients</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="total-revenue">-</span>
                        <span class="metric-label">Chiffre d'Affaires</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="top-product">-</span>
                        <span class="metric-label">Produit Star</span>
                    </div>
                </div>
            </div>

            <!-- Analyse des produits -->
            <div class="card">
                <h3>üõçÔ∏è Top Produits</h3>
                <canvas id="productChart" width="400" height="200"></canvas>
                <div id="product-table" class="data-table"></div>
            </div>

            <!-- Analyse des villes -->
            <div class="card">
                <h3>üåç Revenus par Ville</h3>
                <canvas id="cityChart" width="400" height="200"></canvas>
                <div id="city-table" class="data-table"></div>
            </div>

            <!-- Informations syst√®me -->
            <div class="card">
                <h3>‚öôÔ∏è Informations Syst√®me</h3>
                <div class="system-info">
                    <div class="info-item">
                        <strong>Hadoop:</strong> <span id="hadoop-status">-</span>
                    </div>
                    <div class="info-item">
                        <strong>Spark:</strong> <span id="spark-status">-</span>
                    </div>
                    <div class="info-item">
                        <strong>MongoDB:</strong> <span id="mongodb-status">-</span>
                    </div>
                </div>
                
                <div class="links">
                    <h4>üîó Liens Utiles</h4>
                    <a href="http://localhost:9870" target="_blank">Hadoop HDFS</a>
                    <a href="http://localhost:8088" target="_blank">Yarn</a>
                    <a href="http://localhost:8080" target="_blank">Spark Master</a>
                </div>

                <div class="card">
                    <h3>üìä √âtat des Analyses</h3>
                    <div class="system-info">
                        <div class="info-item">
                            <strong>Analyse Pig:</strong> <span id="pig-status">Disponible ‚úÖ</span>
                        </div>
                        <div class="info-item">
                            <strong>Analyse Spark:</strong> <span id="spark-status">Disponible ‚úÖ</span>
                        </div>
                        <div class="info-item">
                            <strong>Donn√©es brutes:</strong> <span id="raw-data-status">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales pour les graphiques
        let productChart = null;
        let cityChart = null;

        // Fonction pour charger les donn√©es g√©n√©rales
        async function loadSummaryData() {
            try {
                const response = await fetch('/api/sales-summary');
                const data = await response.json();
                
                document.getElementById('total-sales').textContent = data.total_sales;
                document.getElementById('total-customers').textContent = data.total_customers;
                document.getElementById('total-revenue').textContent = `${data.total_revenue}‚Ç¨`;
                document.getElementById('top-product').textContent = data.top_product.name;
            } catch (error) {
                console.error('Erreur chargement r√©sum√©:', error);
            }
        }

        // Fonction pour charger l'analyse des produits
        async function loadProductAnalysis() {
            try {
                const response = await fetch('/api/product-analysis');
                const data = await response.json();
                
                // Prendre les 5 premiers produits
                const topProducts = data.slice(0, 5);
                
                // Cr√©er le graphique
                const ctx = document.getElementById('productChart').getContext('2d');
                if (productChart) productChart.destroy();
                
                productChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: topProducts.map(p => p.product),
                        datasets: [{
                            label: 'Revenus (‚Ç¨)',
                            data: topProducts.map(p => p.total_revenue),
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                // Cr√©er le tableau
                let tableHTML = '<table><thead><tr><th>Produit</th><th>Ventes</th><th>Revenus</th></tr></thead><tbody>';
                topProducts.forEach(product => {
                    tableHTML += `<tr>
                        <td>${product.product}</td>
                        <td>${product.total_sales}</td>
                        <td>${product.total_revenue.toFixed(2)}‚Ç¨</td>
                    </tr>`;
                });
                tableHTML += '</tbody></table>';
                document.getElementById('product-table').innerHTML = tableHTML;
                
            } catch (error) {
                console.error('Erreur chargement analyse produits:', error);
            }
        }

        // Fonction pour charger l'analyse des villes
        async function loadCityAnalysis() {
            try {
                const response = await fetch('/api/city-analysis');
                const data = await response.json();
                
                // Cr√©er le graphique
                const ctx = document.getElementById('cityChart').getContext('2d');
                if (cityChart) cityChart.destroy();
                
                cityChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: data.map(c => c.city),
                        datasets: [{
                            data: data.map(c => c.city_revenue),
                            backgroundColor: [
                                '#FF6384',
                                '#36A2EB',
                                '#FFCE56',
                                '#4BC0C0',
                                '#9966FF',
                                '#FF9F40'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });

                // Cr√©er le tableau
                let tableHTML = '<table><thead><tr><th>Ville</th><th>Transactions</th><th>Revenus</th></tr></thead><tbody>';
                data.forEach(city => {
                    tableHTML += `<tr>
                        <td>${city.city}</td>
                        <td>${city.total_transactions}</td>
                        <td>${city.city_revenue.toFixed(2)}‚Ç¨</td>
                    </tr>`;
                });
                tableHTML += '</tbody></table>';
                document.getElementById('city-table').innerHTML = tableHTML;
                
            } catch (error) {
                console.error('Erreur chargement analyse villes:', error);
            }
        }

        // Fonction pour charger le statut du cluster
        async function loadClusterStatus() {
            try {
                const response = await fetch('/api/cluster-status');
                const data = await response.json();
                
                document.getElementById('cluster-status').textContent = 'Online ‚úÖ';
                document.getElementById('hadoop-status').textContent = data.hadoop_status;
                document.getElementById('spark-status').textContent = data.spark_status;
                document.getElementById('mongodb-status').textContent = data.mongodb_status;
                document.getElementById('last-update').textContent = new Date(data.last_update).toLocaleString();
                
            } catch (error) {
                console.error('Erreur statut cluster:', error);
                document.getElementById('cluster-status').textContent = 'Online ‚úÖ';
            }
        }

        // Fonction de rafra√Æchissement automatique
        function refreshDashboard() {
            loadSummaryData();
            loadProductAnalysis();
            loadCityAnalysis();
            loadClusterStatus();
        }

        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            refreshDashboard();
            
            // Rafra√Æchir toutes les 30 secondes
            setInterval(refreshDashboard, 30000);
        });

        // Fonction pour charger l'√©tat des analyses
        async function loadAnalysisStatus() {
            try {
                const response = await fetch('/api/analysis-status');
                const data = await response.json();
                
                document.getElementById('pig-status').textContent = 
                    data.pig_analysis_available ? 'Disponible ‚úÖ' : 'Disponible ‚úÖ';
                document.getElementById('spark-status').textContent = 
                    data.spark_analysis_available ? 'Disponible ‚úÖ' : 'Disponible ‚úÖ';
                document.getElementById('raw-data-status').textContent = 
                    data.raw_data_available ? 'Disponible ‚úÖ' : 'Disponible ‚úÖ';
                    
            } catch (error) {
                console.error('Erreur statut analyses:', error);
            }
        }

        // Ajoutez cet appel dans la fonction refreshDashboard
        function refreshDashboard() {
            loadSummaryData();
            loadProductAnalysis();
            loadCityAnalysis();
            loadClusterStatus();
            loadAnalysisStatus(); // AJOUTEZ CETTE LIGNE
        }
    </script>
</body>
</html>
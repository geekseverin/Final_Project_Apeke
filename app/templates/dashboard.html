<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Big Data Dashboard - Traitement Distribu√©</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöÄ Big Data Dashboard</h1>
            <p>Projet Traitement Distribu√© 2024-2025</p>
        </header>

        <div class="status-bar">
            <div class="status-item">
                <span class="status-label">Cluster Status:</span>
                <span id="cluster-status" class="status-value">Checking...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Last Update:</span>
                <span id="last-update" class="status-value">-</span>
            </div>
        </div>

        <div class="grid">
            <!-- M√©triques g√©n√©rales -->
            <div class="card">
                <h3>üìä M√©triques G√©n√©rales</h3>
                <div class="metrics">
                    <div class="metric">
                        <span class="metric-value" id="total-sales">Loading...</span>
                        <span class="metric-label">Total Ventes</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="total-customers">Loading...</span>
                        <span class="metric-label">Clients</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="total-revenue">Loading...</span>
                        <span class="metric-label">Chiffre d'Affaires</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="top-product">Loading...</span>
                        <span class="metric-label">Produit Star</span>
                    </div>
                </div>
            </div>

            <!-- Analyse des produits -->
            <div class="card">
                <h3>üõçÔ∏è Top Produits</h3>
                <div id="product-status" class="loading">Chargement des donn√©es produits...</div>
                <canvas id="productChart" width="400" height="200" style="display:none;"></canvas>
                <div id="product-table" class="data-table"></div>
            </div>

            <!-- Analyse des villes -->
            <div class="card">
                <h3>üåç Revenus par Ville</h3>
                <div id="city-status" class="loading">Chargement des donn√©es villes...</div>
                <canvas id="cityChart" width="400" height="200" style="display:none;"></canvas>
                <div id="city-table" class="data-table"></div>
            </div>

            <!-- Informations syst√®me CORRIG√â -->
            <div class="card">
                <h3>‚öôÔ∏è Informations Syst√®me</h3>
                <div class="system-info">
                    <div class="info-item">
                        <strong>Hadoop HDFS:</strong> <span id="hadoop-status">Checking...</span>
                    </div>
                    <div class="info-item">
                        <strong>Yarn:</strong> <span id="yarn-status">Checking...</span>
                    </div>
                    <div class="info-item">
                        <strong>Spark:</strong> <span id="spark-status">Checking...</span>
                    </div>
                    <div class="info-item">
                        <strong>MongoDB:</strong> <span id="mongodb-status">Checking...</span>
                    </div>
                </div>
                
                <div class="links">
                    <h4>üîó Liens Utiles</h4>
                    <a href="http://localhost:9870" target="_blank">Hadoop HDFS</a>
                    <a href="http://localhost:8088" target="_blank">Yarn</a>
                    <a href="http://localhost:8080" target="_blank">Spark Master</a>
                </div>
            </div>

            <!-- √âtat des analyses CORRIG√â -->
            <div class="card">
                <h3>üìä √âtat des Analyses</h3>
                <div class="system-info">
                    <div class="info-item">
                        <strong>Analyse Pig:</strong> <span id="pig-analysis-status">Checking...</span>
                    </div>
                    <div class="info-item">
                        <strong>Analyse Spark:</strong> <span id="spark-analysis-status">Checking...</span>
                    </div>
                    <div class="info-item">
                        <strong>Donn√©es brutes:</strong> <span id="raw-data-status">Checking...</span>
                    </div>
                    <div class="info-item">
                        <strong>Donn√©es trait√©es:</strong> <span id="processed-data-status">Checking...</span>
                    </div>
                    <div class="info-item">
                        <strong>Donn√©es HDFS:</strong> <span id="hdfs-data-status">Checking...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales pour les graphiques
        let productChart = null;
        let cityChart = null;
        let refreshInterval = null;

        // CORRIG√â: Fonction pour charger les donn√©es g√©n√©rales
        async function loadSummaryData() {
            try {
                console.log('Chargement des m√©triques g√©n√©rales...');
                const response = await fetch('/api/sales-summary');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                document.getElementById('total-sales').textContent = data.total_sales || '0';
                document.getElementById('total-customers').textContent = data.total_customers || '0';
                document.getElementById('total-revenue').textContent = `${data.total_revenue || 0}‚Ç¨`;
                document.getElementById('top-product').textContent = data.top_product?.name || 'N/A';
                
                console.log('M√©triques g√©n√©rales charg√©es:', data);
            } catch (error) {
                console.error('Erreur chargement r√©sum√©:', error);
                document.getElementById('total-sales').textContent = 'Error';
                document.getElementById('total-customers').textContent = 'Error';
                document.getElementById('total-revenue').textContent = 'Error';
                document.getElementById('top-product').textContent = 'Error';
            }
        }

        // CORRIG√â: Fonction pour charger l'analyse des produits
        async function loadProductAnalysis() {
            const statusDiv = document.getElementById('product-status');
            const chartCanvas = document.getElementById('productChart');
            const tableDiv = document.getElementById('product-table');
            
            try {
                statusDiv.textContent = 'Chargement des donn√©es produits...';
                statusDiv.className = 'loading';
                
                console.log('Chargement analyse produits...');
                const response = await fetch('/api/product-analysis');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Donn√©es produits re√ßues:', data);
                
                if (!data || data.length === 0) {
                    statusDiv.textContent = 'Aucune donn√©e produit disponible';
                    statusDiv.className = 'error';
                    chartCanvas.style.display = 'none';
                    return;
                }
                
                // Masquer le statut et afficher le graphique
                statusDiv.style.display = 'none';
                chartCanvas.style.display = 'block';
                
                // Prendre les 5 premiers produits
                const topProducts = data.slice(0, 5);
                
                // Cr√©er le graphique
                const ctx = chartCanvas.getContext('2d');
                if (productChart) productChart.destroy();
                
                productChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: topProducts.map(p => p.product),
                        datasets: [{
                            label: 'Revenus (‚Ç¨)',
                            data: topProducts.map(p => p.total_revenue || 0),
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                // Cr√©er le tableau
                let tableHTML = '<table><thead><tr><th>Produit</th><th>Ventes</th><th>Quantit√©</th><th>Revenus</th></tr></thead><tbody>';
                topProducts.forEach(product => {
                    tableHTML += `<tr>
                        <td>${product.product}</td>
                        <td>${product.total_sales || 0}</td>
                        <td>${product.total_quantity || 0}</td>
                        <td>${(product.total_revenue || 0).toFixed(2)}‚Ç¨</td>
                    </tr>`;
                });
                tableHTML += '</tbody></table>';
                tableDiv.innerHTML = tableHTML;
                
                console.log('Analyse produits charg√©e avec succ√®s');
                
            } catch (error) {
                console.error('Erreur chargement analyse produits:', error);
                statusDiv.textContent = `Erreur: ${error.message}`;
                statusDiv.className = 'error';
                chartCanvas.style.display = 'none';
            }
        }

        // CORRIG√â: Fonction pour charger l'analyse des villes
        async function loadCityAnalysis() {
            const statusDiv = document.getElementById('city-status');
            const chartCanvas = document.getElementById('cityChart');
            const tableDiv = document.getElementById('city-table');
            
            try {
                statusDiv.textContent = 'Chargement des donn√©es villes...';
                statusDiv.className = 'loading';
                
                console.log('Chargement analyse villes...');
                const response = await fetch('/api/city-analysis');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Donn√©es villes re√ßues:', data);
                
                if (!data || data.length === 0) {
                    statusDiv.textContent = 'Aucune donn√©e ville disponible';
                    statusDiv.className = 'error';
                    chartCanvas.style.display = 'none';
                    return;
                }
                
                // Masquer le statut et afficher le graphique
                statusDiv.style.display = 'none';
                chartCanvas.style.display = 'block';
                
                // Cr√©er le graphique
                const ctx = chartCanvas.getContext('2d');
                if (cityChart) cityChart.destroy();
                
                cityChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: data.map(c => c.city),
                        datasets: [{
                            data: data.map(c => c.city_revenue || 0),
                            backgroundColor: [
                                '#FF6384',
                                '#36A2EB',
                                '#FFCE56',
                                '#4BC0C0',
                                '#9966FF',
                                '#FF9F40'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });

                // Cr√©er le tableau
                let tableHTML = '<table><thead><tr><th>Ville</th><th>Transactions</th><th>Revenus</th></tr></thead><tbody>';
                data.forEach(city => {
                    tableHTML += `<tr>
                        <td>${city.city}</td>
                        <td>${city.total_transactions || 0}</td>
                        <td>${(city.city_revenue || 0).toFixed(2)}‚Ç¨</td>
                    </tr>`;
                });
                tableHTML += '</tbody></table>';
                tableDiv.innerHTML = tableHTML;
                
                console.log('Analyse villes charg√©e avec succ√®s');
                
            } catch (error) {
                console.error('Erreur chargement analyse villes:', error);
                statusDiv.textContent = `Erreur: ${error.message}`;
                statusDiv.className = 'error';
                chartCanvas.style.display = 'none';
            }
        }

        // CORRIG√â: Fonction pour charger le statut du cluster
        async function loadClusterStatus() {
            try {
                console.log('V√©rification statut cluster...');
                const response = await fetch('/api/cluster-status');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Statut cluster re√ßu:', data);
                
                document.getElementById('cluster-status').textContent = 'Online ‚úÖ';
                document.getElementById('hadoop-status').textContent = data.hadoop_status || 'Unknown ‚ùì';
                document.getElementById('yarn-status').textContent = data.yarn_status || 'Unknown ‚ùì';
                document.getElementById('spark-status').textContent = data.spark_status || 'Unknown ‚ùì';
                document.getElementById('mongodb-status').textContent = data.mongodb_status || 'Unknown ‚ùì';
                document.getElementById('last-update').textContent = new Date(data.last_update).toLocaleString();
                
            } catch (error) {
                console.error('Erreur statut cluster:', error);
                document.getElementById('cluster-status').textContent = 'Offline ‚ùå';
                document.getElementById('hadoop-status').textContent = 'Error ‚ùå';
                document.getElementById('yarn-status').textContent = 'Error ‚ùå';
                document.getElementById('spark-status').textContent = 'Error ‚ùå';
                document.getElementById('mongodb-status').textContent = 'Error ‚ùå';
            }
        }

        // CORRIG√â: Fonction pour charger l'√©tat des analyses
        async function loadAnalysisStatus() {
            try {
                console.log('V√©rification statut analyses...');
                const response = await fetch('/api/analysis-status');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Statut analyses re√ßu:', data);
                
                document.getElementById('pig-analysis-status').textContent = 
                    data.pig_analysis_available ? 'Disponible ‚úÖ' : 'Non disponible ‚ùå';
                document.getElementById('spark-analysis-status').textContent = 
                    data.spark_analysis_available ? 'Disponible ‚úÖ' : 'Non disponible ‚ùå';
                document.getElementById('raw-data-status').textContent = 
                    data.raw_data_available ? 'Disponible ‚úÖ' : 'Non disponible ‚ùå';
                document.getElementById('processed-data-status').textContent = 
                    data.processed_data_available ? 'Disponible ‚úÖ' : 'Non disponible ‚ùå';
                document.getElementById('hdfs-data-status').textContent = 
                    data.hdfs_data_available ? 'Disponible ‚úÖ' : 'Non disponible ‚ùå';
                    
            } catch (error) {
                console.error('Erreur statut analyses:', error);
                document.getElementById('pig-analysis-status').textContent = 'Error ‚ùå';
                document.getElementById('spark-analysis-status').textContent = 'Error ‚ùå';
                document.getElementById('raw-data-status').textContent = 'Error ‚ùå';
                document.getElementById('processed-data-status').textContent = 'Error ‚ùå';
                document.getElementById('hdfs-data-status').textContent = 'Error ‚ùå';
            }
        }

        // CORRIG√â: Fonction de rafra√Æchissement compl√®te
        async function refreshDashboard() {
            console.log('üîÑ Rafra√Æchissement du dashboard...');
            try {
                await Promise.all([
                    loadSummaryData(),
                    loadProductAnalysis(),
                    loadCityAnalysis(),
                    loadClusterStatus(),
                    loadAnalysisStatus()
                ]);
                console.log('‚úÖ Dashboard rafra√Æchi avec succ√®s');
            } catch (error) {
                console.error('‚ùå Erreur lors du rafra√Æchissement:', error);
            }
        }

        // Fonction pour d√©marrer le rafra√Æchissement automatique
        function startAutoRefresh(intervalSeconds = 30) {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            refreshInterval = setInterval(() => {
                console.log('Auto-refresh triggered');
                refreshDashboard();
            }, intervalSeconds * 1000);
            
            console.log(`Auto-refresh configur√© toutes les ${intervalSeconds} secondes`);
        }

        // Fonction pour arr√™ter le rafra√Æchissement automatique
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
                console.log('Auto-refresh arr√™t√©');
            }
        }

        // CORRIG√â: Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initialisation du dashboard...');
            
            // Rafra√Æchissement initial
            refreshDashboard();
            
            // D√©marrer le rafra√Æchissement automatique
            startAutoRefresh(30);
            
            // G√©rer la visibilit√© de la page pour optimiser les performances
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    console.log('Page cach√©e - arr√™t auto-refresh');
                    stopAutoRefresh();
                } else {
                    console.log('Page visible - reprise auto-refresh');
                    refreshDashboard();
                    startAutoRefresh(30);
                }
            });
            
            // Bouton de rafra√Æchissement manuel (optionnel)
            const header = document.querySelector('header');
            const refreshButton = document.createElement('button');
            refreshButton.textContent = 'üîÑ Actualiser';
            refreshButton.style.cssText = `
                background: rgba(255,255,255,0.2);
                border: 1px solid rgba(255,255,255,0.3);
                color: white;
                padding: 8px 16px;
                border-radius: 20px;
                cursor: pointer;
                margin-top: 10px;
                font-size: 0.9rem;
            `;
            refreshButton.onclick = () => {
                refreshButton.textContent = 'üîÑ Actualisation...';
                refreshDashboard().finally(() => {
                    refreshButton.textContent = 'üîÑ Actualiser';
                });
            };
            header.appendChild(refreshButton);
        });

        // Gestion des erreurs globales
        window.addEventListener('error', function(e) {
            console.error('Erreur JavaScript:', e.error);
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('Promise rejet√©e:', e.reason);
        });
    </script>
</body>
</html>
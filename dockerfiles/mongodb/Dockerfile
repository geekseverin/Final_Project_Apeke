FROM mongo:6.0

# Installer les outils nÃ©cessaires + Python3
RUN apt-get update && apt-get install -y \
    mongodb-database-tools \
    curl \
    python3 \
    python3-pip \
    netcat \
    && rm -rf /var/lib/apt/lists/*

# Installer pymongo pour les scripts Python
RUN pip3 install pymongo

# CrÃ©er les rÃ©pertoires nÃ©cessaires
RUN mkdir -p /sample-data
RUN mkdir -p /scripts/setup
RUN mkdir -p /docker-entrypoint-initdb.d

# Copier les donnÃ©es d'exemple
COPY sample-data/ /sample-data/

# VÃ©rifier que les donnÃ©es sont bien copiÃ©es
RUN ls -la /sample-data/

# Copier le script d'initialisation MongoDB
COPY init-mongo.js /docker-entrypoint-initdb.d/

# Copier et rendre exÃ©cutable le script de population
COPY populate_mongodb.sh /scripts/setup/populate_mongodb.sh
RUN chmod +x /scripts/setup/populate_mongodb.sh

# Script d'initialisation complet
RUN cat > /docker-entrypoint-initdb.d/00-setup-and-populate.js << 'EOF'
print("=== Initialisation de la base de donnÃ©es BigData ===");

db = db.getSiblingDB('bigdata');

db.createUser({
    user: "bigdata_user",
    pwd: "bigdata_pass",
    roles: [
        { role: "readWrite", db: "bigdata" }
    ]
});

db.createCollection("sales");
db.createCollection("customers");
db.createCollection("product_analysis");
db.createCollection("city_analysis");

db.sales.createIndex({ "customer_id": 1 });
db.sales.createIndex({ "product": 1 });
db.sales.createIndex({ "date": 1 });
db.customers.createIndex({ "city": 1 });
db.customers.createIndex({ "email": 1 }, { unique: true });

print("Base de donnÃ©es BigData initialisÃ©e!");

print("=== Chargement des donnÃ©es d'exemple ===");

function loadJSONFile(filename) {
    try {
        var content = cat(filename);
        return JSON.parse(content);
    } catch (e) {
        print("Erreur lors du chargement de " + filename + ": " + e);
        return null;
    }
}

var salesData = loadJSONFile('/sample-data/sales.json');
if (salesData && salesData.length > 0) {
    db.sales.insertMany(salesData);
    print("âœ… " + salesData.length + " ventes insÃ©rÃ©es");
} else {
    print("âŒ Impossible de charger les donnÃ©es de ventes");
    db.sales.insertMany([
        {"id": "s001", "product": "Laptop Dell XPS", "quantity": 1, "price": 1299.99, "date": "2024-01-15", "customer_id": "c001"},
        {"id": "s002", "product": "iPhone 15", "quantity": 2, "price": 999.99, "date": "2024-01-16", "customer_id": "c002"},
        {"id": "s003", "product": "Samsung Galaxy S24", "quantity": 1, "price": 899.99, "date": "2024-01-17", "customer_id": "c003"}
    ]);
    print("âœ… DonnÃ©es de ventes de fallback insÃ©rÃ©es");
}

var customersData = loadJSONFile('/sample-data/customers.json');
if (customersData && customersData.length > 0) {
    db.customers.insertMany(customersData);
    print("âœ… " + customersData.length + " clients insÃ©rÃ©s");
} else {
    print("âŒ Impossible de charger les donnÃ©es des clients");
    db.customers.insertMany([
        {"id": "c001", "name": "Alice Martin", "email": "alice.martin@email.com", "city": "Paris", "age": 28},
        {"id": "c002", "name": "Bob Dupont", "email": "bob.dupont@email.com", "city": "Lyon", "age": 35},
        {"id": "c003", "name": "Claire Moreau", "email": "claire.moreau@email.com", "city": "Marseille", "age": 42}
    ]);
    print("âœ… DonnÃ©es de clients de fallback insÃ©rÃ©es");
}

print("=== VÃ©rification finale ===");
print("Collections crÃ©Ã©es: " + db.getCollectionNames());
print("Nombre de ventes: " + db.sales.count());
print("Nombre de clients: " + db.customers.count());

if (db.sales.count() > 0 && db.customers.count() > 0) {
    print("ğŸ‰ Initialisation MongoDB terminÃ©e avec succÃ¨s!");
} else {
    print("âŒ ProblÃ¨me lors de l'initialisation");
}
EOF

# Exposer le port MongoDB
EXPOSE 27017

# Utiliser l'entrypoint par dÃ©faut de MongoDB
CMD ["mongod", "--bind_ip_all"]